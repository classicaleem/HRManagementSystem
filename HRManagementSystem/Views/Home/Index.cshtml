@{
    ViewData["Title"] = "Dashboard";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* Enhanced Dashboard Styles */
    .dashboard-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }

    /* Filter section for super admin */
    .filter-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .filter-title {
        color: #2c3e50;
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #34495e;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-select {
        padding: 10px 15px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #2c3e50;
        background: white;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .filter-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .filter-select:hover {
            border-color: #3498db;
        }

    .filter-btn {
        padding: 10px 25px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }

        .filter-btn.primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

            .filter-btn.primary:hover {
                background: linear-gradient(135deg, #2980b9, #21618c);
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            }

        .filter-btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

            .filter-btn.secondary:hover {
                background: linear-gradient(135deg, #7f8c8d, #6c7a89);
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
            }

    /* Summary cards for super admin */
    .summary-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .summary-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-card.present {
            border-color: #27ae60;
        }

        .summary-card.absent {
            border-color: #e74c3c;
        }

        .summary-card.layoff {
            border-color: #f39c12;
        }

        .summary-card.total {
            border-color: #3498db;
        }

    .summary-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .summary-card.present .summary-icon {
        color: #27ae60;
    }

    .summary-card.absent .summary-icon {
        color: #e74c3c;
    }

    .summary-card.layoff .summary-icon {
        color: #f39c12;
    }

    .summary-card.total .summary-icon {
        color: #3498db;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1;
        margin-bottom: 5px;
    }

    .summary-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-percentage {
        font-size: 0.75rem;
        color: #95a5a6;
        margin-top: 5px;
    }
    /* Compact companies grid for superadmin */
    .companies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    /* Company-specific containers for superadmin - COMPACT */
    .company-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

        .company-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

    .company-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 2px solid #ecf0f1;
    }

    .company-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .company-title h3 {
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }

    .company-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
    }

        .company-badge.classic {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .company-badge.delta {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .company-badge.aston {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

    .company-last-updated {
        color: #7f8c8d;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Compact Company Stats Grid */
    .company-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }

    /* Compact Circle Progress */
    .stat-circle {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .circle-container {
        position: relative;
        width: 70px;
        height: 70px;
        margin-bottom: 8px;
    }

    .circle-bg {
        fill: none;
        stroke: #ecf0f1;
        stroke-width: 6;
    }

    .circle-progress {
        fill: none;
        stroke-width: 6;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dasharray 1s ease-in-out;
    }

        .circle-progress.present {
            stroke: #27ae60;
        }

        .circle-progress.absent {
            stroke: #e74c3c;
        }

        .circle-progress.layoff {
            stroke: #f39c12;
        }

        .circle-progress.total {
            stroke: #3498db;
        }

    .circle-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .circle-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        display: block;
        line-height: 1;
    }

    .circle-count {
        font-size: 0.65rem;
        color: #7f8c8d;
        margin-top: 2px;
    }

    .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #34495e;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-description {
        font-size: 0.7rem;
        color: #7f8c8d;
        margin-top: 3px;
        display: none; /* Hide on compact view */
    }

    /* Real-time Stats for non-admin */
    .real-time-stats {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    .stats-header {
        text-align: center;
        margin-bottom: 30px;
    }

        .stats-header h2 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

    .last-updated {
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmin(200px, 1fr));
        gap: 30px;
        margin-top: 30px;
    }

    /* Shift Stats */
    .shift-stats-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    .shift-header {
        text-align: center;
        margin-bottom: 30px;
    }

        .shift-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

    .shift-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
    }

    .shift-card {
        border-radius: 15px;
        padding: 25px;
        color: white;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .shift-card.first-shift {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
        }

        .shift-card.general-shift {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
        }

        .shift-card.second-shift {
            background: linear-gradient(135deg, #A8E6CF 0%, #88D8A3 100%);
        }

        .shift-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

    .shift-name {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .shift-stats-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .shift-metric {
        text-align: center;
    }

    .shift-metric-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
    }

    .shift-metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .shift-progress-container {
        margin-top: 20px;
    }

    .shift-progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-segments {
        display: flex;
        height: 100%;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-segment {
        transition: width 1s ease-in-out;
    }

        .progress-segment.present {
            background: rgba(255, 255, 255, 0.9);
        }

        .progress-segment.absent {
            background: rgba(255, 255, 255, 0.4);
        }

        .progress-segment.layoff {
            background: rgba(255, 255, 255, 0.6);
        }

    .progress-legend {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 0.8rem;
        opacity: 0.9;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

        .legend-color.present {
            background: rgba(255, 255, 255, 0.9);
        }

        .legend-color.absent {
            background: rgba(255, 255, 255, 0.4);
        }

        .legend-color.layoff {
            background: rgba(255, 255, 255, 0.6);
        }

    /* Action Cards */
    .action-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 15px;
        padding: 30px;
        height: 100%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        text-decoration: none;
        color: inherit;
        display: block;
    }

        .action-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-decoration: none;
            color: inherit;
        }

    .action-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        display: block;
    }

    .action-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .action-description {
        color: #7f8c8d;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .action-card.primary .action-icon {
        color: #3498db;
    }

    .action-card.success .action-icon {
        color: #2ecc71;
    }

    .action-card.warning .action-icon {
        color: #f39c12;
    }

    .action-card.danger .action-icon {
        color: #e74c3c;
    }

    .action-card.info .action-icon {
        color: #9b59b6;
    }

    .info-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        height: 100%;
    }

        .info-card h5 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
        }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #ecf0f1;
    }

        .info-item:last-child {
            border-bottom: none;
        }

    .info-label {
        font-weight: 500;
        color: #34495e;
    }

    .info-value {
        font-weight: 600;
        color: #2980b9;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-success {
        background-color: #2ecc71;
    }

    .status-warning {
        background-color: #f39c12;
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive Design */
    @@media (max-width: 1200px) {
        .companies-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .companies-grid {
            grid-template-columns: 1fr;
        }

        .company-stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .shift-grid {
            grid-template-columns: 1fr;
        }

        .circle-container {
            width: 60px;
            height: 60px;
        }

        .circle-value {
            font-size: 0.95rem;
        }

        .circle-count {
            font-size: 0.6rem;
        }

        .company-title h3 {
            font-size: 1.1rem;
        }

        .stat-label {
            font-size: 0.7rem;
        }

        .stats-header h2 {
            font-size: 2rem;
        }

        .shift-header h2 {
            font-size: 1.5rem;
        }
    }
</style>

<div class="dashboard-container">
    <div class="container-fluid">

        @if (ViewBag.UserRole == "Admin")
        {
            <div class="alert alert-success" style="border: none; border-radius: 10px; background: rgba(212, 237, 218, 0.9); backdrop-filter: blur(10px);">
                <i class="fas fa-crown"></i> <strong>Super Admin Access:</strong> You have full access to all company data and analytics.
            </div>

            <!-- Filter Section for Super Admin -->
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> Filters <span style="font-size: 0.8rem; color: #7f8c8d; font-weight: normal;">(Auto-updates on change)</span>
                </div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-building"></i> Company
                        </label>
                        <select id="companyFilter" class="filter-select">
                            <option value="0">ALL</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-sitemap"></i> Department
                        </label>
                        <select id="departmentFilter" class="filter-select">
                            <option value="">ALL</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-tags"></i> Category
                        </label>
                        <select id="categoryFilter" class="filter-select">
                            <option value="">ALL</option>
                        </select>
                    </div>
                    @*      <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-clock"></i> Shift
                        </label>
                        <select id="shiftFilter" class="filter-select">
                            <option value="">ALL</option>
                        </select>
                    </div> *@
                    <div class="filter-group">
                        <button onclick="resetFilters()" class="filter-btn secondary" style="width: 100%;">
                            <i class="fas fa-redo"></i> Reset All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="summary-section" id="summarySection">
                <div class="summary-grid">
                    <div class="summary-card total">
                        <div class="summary-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="summary-value" id="summaryTotal">0</div>
                        <div class="summary-label">Total Employees</div>
                        <div class="summary-percentage">100%</div>
                    </div>
                    <div class="summary-card present">
                        <div class="summary-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="summary-value" id="summaryPresent">0</div>
                        <div class="summary-label">Present</div>
                        <div class="summary-percentage" id="summaryPresentPercent">0%</div>
                    </div>
                    <div class="summary-card absent">
                        <div class="summary-icon">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div class="summary-value" id="summaryAbsent">0</div>
                        <div class="summary-label">Absent</div>
                        <div class="summary-percentage" id="summaryAbsentPercent">0%</div>
                    </div>
                    <div class="summary-card layoff">
                        <div class="summary-icon">
                            <i class="fas fa-user-slash"></i>
                        </div>
                        <div class="summary-value" id="summaryLayoff">0</div>
                        <div class="summary-label">Layoff</div>
                        <div class="summary-percentage" id="summaryLayoffPercent">0%</div>
                    </div>
                </div>
            </div>

            <!-- Super Admin: Company-wise containers -->
            <div class="companies-grid" id="companiesContainer">
                <!-- Loading state -->
                <div class="text-center text-white py-5" style="grid-column: 1 / -1;">
                    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                    <h4>Loading company data...</h4>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info d-flex justify-content-between align-items-center" style="border: none; border-radius: 10px; background: rgba(209, 236, 241, 0.9); backdrop-filter: blur(10px);">
                <div>
                    <i class="fas fa-building"></i> <strong>Company:</strong> @User.FindFirst("CompanyName")?.Value
                </div>
                <div>
                    <small style="opacity: 0.8;">
                        <i class="fas fa-calendar-alt"></i> @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
                    </small>
                </div>
            </div>

            <!-- Regular user: Single company stats -->
            <div class="real-time-stats">
                <div class="stats-header">
                    <h2><i class="fas fa-chart-pie"></i> Today's Attendance Distribution</h2>
                    <div class="last-updated" id="lastUpdated">
                        <i class="fas fa-sync-alt loading-spinner"></i> Loading...
                    </div>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Shift Stats for regular users -->
            <div class="shift-stats-container">
                <div class="shift-header">
                    <h2><i class="fas fa-clock"></i> Shift-wise Performance</h2>
                    <div class="last-updated" id="shiftLastUpdated">
                        <i class="fas fa-sync-alt loading-spinner"></i> Loading shift data...
                    </div>
                </div>

                <div class="shift-grid" id="shiftGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        }

        <div class="row">
            @if (ViewBag.UserRole == "Admin")
            {
                <!-- Compact Actions for Super Admin -->
                <div class="col-12">
                    <h3 style="color: white; margin-bottom: 20px; font-weight: 600;">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h3>
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "AttendanceSummary")" class="action-card primary" style="padding: 20px;">
                                <i class="fas fa-chart-line action-icon" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h5 class="action-title" style="font-size: 1.1rem; margin-bottom: 8px;">Attendance Summary</h5>
                                <p class="action-description" style="font-size: 0.85rem;">
                                    View comprehensive reports
                                </p>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="@Url.Action("AttendanceReport", "Home")" class="action-card success" style="padding: 20px;">
                                <i class="fas fa-clipboard-list action-icon" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h5 class="action-title" style="font-size: 1.1rem; margin-bottom: 8px;">Daily Report</h5>
                                <p class="action-description" style="font-size: 0.85rem;">
                                    Department-wise breakdown
                                </p>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "CostsDashboard")" class="action-card warning" style="padding: 20px;">
                                <i class="fas fa-dollar-sign action-icon" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h5 class="action-title" style="font-size: 1.1rem; margin-bottom: 8px;">Costs Dashboard</h5>
                                <p class="action-description" style="font-size: 0.85rem;">
                                    Cost analysis & tracking
                                </p>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "EmployeeStatus")" class="action-card danger" style="padding: 20px;">
                                <i class="fas fa-users action-icon" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h5 class="action-title" style="font-size: 1.1rem; margin-bottom: 8px;">Employee Status</h5>
                                <p class="action-description" style="font-size: 0.85rem;">
                                    Manage employee status
                                </p>
                            </a>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- Regular Actions for other users -->
                <div class="col-md-8">
                    <h3 style="color: white; margin-bottom: 25px; font-weight: 600;">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h3>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <a href="@Url.Action("Index", "AttendanceSummary")" class="action-card primary">
                                <i class="fas fa-chart-line action-icon"></i>
                                <h5 class="action-title">Attendance Summary</h5>
                                <p class="action-description">
                                    View comprehensive attendance reports with filtering and export capabilities including layoff tracking.
                                </p>
                            </a>
                        </div>
                        <div class="col-md-6 mb-4">
                            <a href="@Url.Action("AttendanceReport", "Home")" class="action-card success">
                                <i class="fas fa-clipboard-list action-icon"></i>
                                <h5 class="action-title">Daily Report</h5>
                                <p class="action-description">
                                    Generate detailed daily attendance reports with department-wise breakdown and employee status.
                                </p>
                            </a>
                        </div>
                        <div class="col-md-6 mb-4">
                            <a href="@Url.Action("DepartmentAttendance", "Home")" class="action-card warning">
                                <i class="fas fa-building action-icon"></i>
                                <h5 class="action-title">Department Analysis</h5>
                                <p class="action-description">
                                    Analyze department-wise attendance patterns and section-wise performance metrics with layoff insights.
                                </p>
                            </a>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="action-card info" style="cursor: pointer;" onclick="refreshAttendance()">
                                <i class="fas fa-sync-alt action-icon" id="refreshIcon"></i>
                                <h5 class="action-title">Refresh Data</h5>
                                <p class="action-description">
                                    Update attendance data and synchronize with the latest punch records including layoff status.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information for regular users -->
                <div class="col-md-4">
                    <h3 style="color: white; margin-bottom: 25px; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> System Info
                    </h3>
                    <div class="info-card">
                        <h5><i class="fas fa-server"></i> System Status</h5>
                        <div class="info-item">
                            <span class="info-label">
                                <span class="status-indicator status-success"></span>Current Date
                            </span>
                            <span class="info-value">@DateTime.Now.ToString("yyyy-MM-dd")</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <span class="status-indicator status-success"></span>Your Role
                            </span>
                            <span class="info-value">@User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <span class="status-indicator status-success"></span>Auto-refresh
                            </span>
                            <span class="info-value">Every 3 min</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <span class="status-indicator status-success"></span>Real-time Updates
                            </span>
                            <span class="info-value">Enabled</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <span class="status-indicator status-success"></span>Layoff Tracking
                            </span>
                            <span class="info-value">Active</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    let refreshInterval;
    var userCompanyCode = @ViewBag.UserCompanyCode;
    var userRole = '@ViewBag.UserRole';
    var isSuperAdmin = @(ViewBag.IsSuperAdmin ? "true" : "false");
    var currentFilters = {
        companyCode: 0,
        department: '',
        category: '',
        shift: ''
    };

    // Flag to prevent concurrent filter loads
    let isLoadingFilters = false;

    // Helper function to get company badge class
    function getCompanyBadgeClass(companyName) {
        const name = companyName.toLowerCase();
        if (name.includes('classic')) return 'classic';
        if (name.includes('delta')) return 'delta';
        if (name.includes('aston')) return 'aston';
        return 'classic';
    }

    // Load filter options for super admin
    function loadFilterOptions() {
        console.log('=== STARTING loadFilterOptions ===');

        if (isLoadingFilters) {
            console.log('Already loading filters, skipping...');
            return;
        }

        isLoadingFilters = true;

        // Load companies from DailyAttendance
        console.log('Fetching companies from: /Home/GetCompaniesFromAttendance');
        fetch('/Home/GetCompaniesFromAttendance')
            .then(response => {
                console.log('Companies response status:', response.status);
                console.log('Companies response ok:', response.ok);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                console.log('Companies raw response:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('Companies parsed data:', data);
                    console.log('Is array?', Array.isArray(data));
                    console.log('Data length:', data ? data.length : 'null');

                    const companySelect = document.getElementById('companyFilter');
                    if (!companySelect) {
                        console.error('ERROR: companyFilter element not found in DOM!');
                        return;
                    }

                    if (Array.isArray(data) && data.length > 0) {
                        companySelect.innerHTML = '<option value="0">ALL</option>';
                        data.forEach((company, index) => {
                            console.log(`Adding company ${index}:`, company);
                            companySelect.innerHTML += `<option value="${company.companyCode}">${company.companyName}</option>`;
                        });
                        console.log('✓ Companies loaded successfully:', data.length);
                    } else {
                        console.error('ERROR: No companies data or not an array:', data);
                    }
                } catch (parseError) {
                    console.error('ERROR parsing companies JSON:', parseError);
                    console.error('Raw text was:', text);
                }
            })
            .catch(error => {
                console.error('ERROR loading companies:', error);
                console.error('Error stack:', error.stack);
            })
            .finally(() => {
                isLoadingFilters = false;
            });

        // Load departments
        console.log('Loading departments...');
        loadDepartments(0);

        // Load categories
        console.log('Loading categories...');
        loadCategories(0);

        // Load shifts
        console.log('Loading shifts...');
        loadShifts(0);
    }

    // Load departments based on company from DailyAttendance
    function loadDepartments(companyCode) {
        console.log('=== loadDepartments called with companyCode:', companyCode);

        const url = `/Home/GetDepartmentsFromAttendance?companyCode=${companyCode}`;
        console.log('Fetching departments from:', url);

        fetch(url)
            .then(response => {
                console.log('Departments response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                console.log('Departments raw response:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('Departments parsed data:', data);
                    console.log('Is array?', Array.isArray(data));
                    console.log('Data length:', data ? data.length : 'null');

                    const deptSelect = document.getElementById('departmentFilter');
                    if (!deptSelect) {
                        console.error('ERROR: departmentFilter element not found in DOM!');
                        return;
                    }

                    if (Array.isArray(data)) {
                        deptSelect.innerHTML = '<option value="">ALL</option>';
                        if (data.length > 0) {
                            data.forEach((dept, index) => {
                                console.log(`Adding department ${index}:`, dept);
                                deptSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
                            });
                            console.log('✓ Departments loaded successfully:', data.length);
                        } else {
                            console.warn('WARNING: No departments returned from server');
                        }
                    } else {
                        console.error('ERROR: Departments data is not an array:', data);
                    }
                } catch (parseError) {
                    console.error('ERROR parsing departments JSON:', parseError);
                    console.error('Raw text was:', text);
                }
            })
            .catch(error => {
                console.error('ERROR loading departments:', error);
                console.error('Error stack:', error.stack);
            });
    }

    // Load categories based on company from DailyAttendance
    function loadCategories(companyCode) {
        console.log('=== loadCategories called with companyCode:', companyCode);

        const url = `/Home/GetCategoriesFromAttendance?companyCode=${companyCode}`;
        console.log('Fetching categories from:', url);

        fetch(url)
            .then(response => {
                console.log('Categories response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                console.log('Categories raw response:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('Categories parsed data:', data);
                    console.log('Is array?', Array.isArray(data));
                    console.log('Data length:', data ? data.length : 'null');

                    const catSelect = document.getElementById('categoryFilter');
                    if (!catSelect) {
                        console.error('ERROR: categoryFilter element not found in DOM!');
                        return;
                    }

                    if (Array.isArray(data)) {
                        catSelect.innerHTML = '<option value="">ALL</option>';
                        if (data.length > 0) {
                            data.forEach((cat, index) => {
                                console.log(`Adding category ${index}:`, cat);
                                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                            });
                            console.log('✓ Categories loaded successfully:', data.length);
                        } else {
                            console.warn('WARNING: No categories returned from server');
                        }
                    } else {
                        console.error('ERROR: Categories data is not an array:', data);
                    }
                } catch (parseError) {
                    console.error('ERROR parsing categories JSON:', parseError);
                    console.error('Raw text was:', text);
                }
            })
            .catch(error => {
                console.error('ERROR loading categories:', error);
                console.error('Error stack:', error.stack);
            });
    }

    // Load shifts based on company from DailyAttendance
    function loadShifts(companyCode) {
        console.log('=== loadShifts called with companyCode:', companyCode);

        const url = `/Home/GetShiftsFromAttendance?companyCode=${companyCode}`;
        console.log('Fetching shifts from:', url);

        fetch(url)
            .then(response => {
                console.log('Shifts response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                console.log('Shifts raw response:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('Shifts parsed data:', data);
                    console.log('Is array?', Array.isArray(data));
                    console.log('Data length:', data ? data.length : 'null');

                    const shiftSelect = document.getElementById('shiftFilter');
                    if (!shiftSelect) {
                        console.error('ERROR: shiftFilter element not found in DOM!');
                        return;
                    }

                    if (Array.isArray(data)) {
                        shiftSelect.innerHTML = '<option value="">ALL</option>';
                        if (data.length > 0) {
                            data.forEach((shift, index) => {
                                console.log(`Adding shift ${index}:`, shift);
                                shiftSelect.innerHTML += `<option value="${shift.shiftCode}">${shift.shiftName}</option>`;
                            });
                            console.log('✓ Shifts loaded successfully:', data.length);
                        } else {
                            console.warn('WARNING: No shifts returned from server');
                        }
                    } else {
                        console.error('ERROR: Shifts data is not an array:', data);
                    }
                } catch (parseError) {
                    console.error('ERROR parsing shifts JSON:', parseError);
                    console.error('Raw text was:', text);
                }
            })
            .catch(error => {
                console.error('ERROR loading shifts:', error);
                console.error('Error stack:', error.stack);
            });
    }

    // Handle filter change - auto reload data
    function onFilterChange(event) {
        console.log('=== onFilterChange TRIGGERED ===');
        console.log('Event:', event);
        console.log('Event target:', event ? event.target : 'no event');

        const companyCode = parseInt(document.getElementById('companyFilter').value);
        const department = document.getElementById('departmentFilter').value;
        const category = document.getElementById('categoryFilter').value;
        // const shift = document.getElementById('shiftFilter').value;

        console.log('Filter values retrieved:', {
            companyCode,
            department,
            category
            // shift
        });

        // Update current filters
        currentFilters.companyCode = companyCode;
        currentFilters.department = department;
        currentFilters.category = category;
        // currentFilters.shift = shift;

        console.log('Updated currentFilters:', currentFilters);

        // Reload dependent dropdowns when company changes
        if (event && event.target && event.target.id === 'companyFilter') {
            console.log('Company filter changed - reloading dependent dropdowns');
            loadDepartments(companyCode);
            loadCategories(companyCode);
            loadShifts(companyCode);
        }

        // Auto-reload data
        console.log('Calling loadAllCompaniesData()...');
        loadAllCompaniesData();
    }

    // Apply filters (kept for compatibility but now just calls onFilterChange)
    function applyFilters() {
        console.log('applyFilters() called - redirecting to onFilterChange()');
        onFilterChange();
    }

    // Reset filters
    function resetFilters() {
        console.log('Resetting filters...');

        document.getElementById('companyFilter').value = '0';
        document.getElementById('departmentFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        // document.getElementById('shiftFilter').value = '';

        currentFilters = {
            companyCode: 0,
            department: '',
            category: ''
            // shift: ''
        };

        // Reload all dropdowns
        loadDepartments(0);
        loadCategories(0);
        loadShifts(0);

        // Reload data
        loadAllCompaniesData();
    }

    // Create circular progress SVG for a stat - COMPACT VERSION
    function createCircleProgress(stat, value, count, className) {
        const circumference = 2 * Math.PI * 32;
        const dashArray = stat === 'Total' ? circumference : (value / 100) * circumference;

        return `
            <div class="stat-circle">
                <div class="circle-container">
                    <svg width="70" height="70">
                        <circle class="circle-bg" cx="35" cy="35" r="32"></circle>
                        <circle class="circle-progress ${className}" cx="35" cy="35" r="32"
                                stroke-dasharray="${dashArray} ${circumference}"></circle>
                    </svg>
                    <div class="circle-text">
                        <span class="circle-value">${value}%</span>
                        <div class="circle-count">${count}</div>
                    </div>
                </div>
                <div class="stat-label">${stat}</div>
            </div>
        `;
    }

    // Update company container with stats
    function updateCompanyContainer(company) {
        const total = company.totalEmployees;
        const present = company.presentEmployees;
        const absent = company.absentEmployees;
        const layoff = company.layoffEmployees || 0;

        const presentPercent = total > 0 ? Math.round((present / total) * 100) : 0;
        const absentPercent = total > 0 ? Math.round((absent / total) * 100) : 0;
        const layoffPercent = total > 0 ? Math.round((layoff / total) * 100) : 0;

        const badgeClass = getCompanyBadgeClass(company.companyName);

        let html = `
            <div class="company-section" data-company="${company.companyCode}">
                <div class="company-header">
                    <div class="company-title">
                        <h3>
                            <i class="fas fa-industry"></i> ${company.companyName}
                        </h3>
                    </div>
                    <span class="company-badge ${badgeClass}">${company.attendancePercentage}%</span>
                </div>

                <div class="company-stats-grid">
                    ${createCircleProgress('Present', presentPercent, present, 'present')}
                    ${createCircleProgress('Absent', absentPercent, absent, 'absent')}
                    ${createCircleProgress('Layoff', layoffPercent, layoff, 'layoff')}
                    ${createCircleProgress('Total', 100, total, 'total')}
                </div>
            </div>
        `;

        return html;
    }

    // Update summary section
    function updateSummary(companies) {
        let totalEmployees = 0;
        let totalPresent = 0;
        let totalAbsent = 0;
        let totalLayoff = 0;

        companies.forEach(company => {
            totalEmployees += company.totalEmployees;
            totalPresent += company.presentEmployees;
            totalAbsent += company.absentEmployees;
            totalLayoff += company.layoffEmployees || 0;
        });

        const presentPercent = totalEmployees > 0 ? Math.round((totalPresent / totalEmployees) * 100) : 0;
        const absentPercent = totalEmployees > 0 ? Math.round((totalAbsent / totalEmployees) * 100) : 0;
        const layoffPercent = totalEmployees > 0 ? Math.round((totalLayoff / totalEmployees) * 100) : 0;

        document.getElementById('summaryTotal').textContent = totalEmployees.toLocaleString();
        document.getElementById('summaryPresent').textContent = totalPresent.toLocaleString();
        document.getElementById('summaryAbsent').textContent = totalAbsent.toLocaleString();
        document.getElementById('summaryLayoff').textContent = totalLayoff.toLocaleString();

        document.getElementById('summaryPresentPercent').textContent = presentPercent + '%';
        document.getElementById('summaryAbsentPercent').textContent = absentPercent + '%';
        document.getElementById('summaryLayoffPercent').textContent = layoffPercent + '%';
    }

    // Load all companies data for superadmin with filters
    function loadAllCompaniesData() {
        console.log('=== loadAllCompaniesData CALLED ===');
        console.log('Current filters:', currentFilters);

        const params = new URLSearchParams({
            companyCode: currentFilters.companyCode,
            department: currentFilters.department || '',
            category: currentFilters.category || ''
            // shift: currentFilters.shift || ''
        });

        const url = '/Home/GetAllCompaniesStats?' + params.toString();
        console.log('Fetching from URL:', url);

        fetch(url)
            .then(response => {
                console.log('GetAllCompaniesStats response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('GetAllCompaniesStats data received:', data);

                if (data.success && data.companies) {
                    const container = document.getElementById('companiesContainer');

                    if (data.companies.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-white py-5" style="grid-column: 1 / -1;">
                                <i class="fas fa-info-circle fa-3x mb-3"></i>
                                <h4>No data found for the selected filters</h4>
                                <p>Try adjusting your filter criteria</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';

                    // Filter companies if specific company selected
                    let filteredCompanies = data.companies;
                    if (currentFilters.companyCode > 0) {
                        filteredCompanies = data.companies.filter(c => c.companyCode === currentFilters.companyCode);
                        console.log('Filtered to specific company:', currentFilters.companyCode);
                    }

                    console.log('Total companies to display:', filteredCompanies.length);

                    filteredCompanies.forEach(company => {
                        html += updateCompanyContainer(company);
                    });

                    container.innerHTML = html;

                    // Update summary with filtered data
                    updateSummary(filteredCompanies);

                    console.log('✓ Companies data loaded and rendered successfully');
                } else {
                    console.error('Invalid response from GetAllCompaniesStats:', data);
                    document.getElementById('companiesContainer').innerHTML = `
                        <div class="alert alert-warning" style="grid-column: 1 / -1;">
                            <i class="fas fa-exclamation-triangle"></i> Invalid response format from server
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('ERROR loading companies data:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('companiesContainer').innerHTML = `
                    <div class="alert alert-danger" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-triangle"></i> Error loading company data: ${error.message}
                    </div>
                `;
            });
    }

    // Update stats for regular users
    function updateMainStats(data) {
        const total = data.totalEmployees;
        const present = data.presentEmployees;
        const absent = data.absentEmployees;
        const layoff = data.layoffEmployees || 0;

        const presentPercent = total > 0 ? Math.round((present / total) * 100) : 0;
        const absentPercent = total > 0 ? Math.round((absent / total) * 100) : 0;
        const layoffPercent = total > 0 ? Math.round((layoff / total) * 100) : 0;

        const grid = document.getElementById('statsGrid');
        let html = '';

        html += createCircleProgress('Present', presentPercent, present, 'present');
        html += createCircleProgress('Absent', absentPercent, absent, 'absent');
        html += createCircleProgress('Layoff', layoffPercent, layoff, 'layoff');
        html += createCircleProgress('Total', 100, total, 'total');

        grid.innerHTML = html;
        document.getElementById('lastUpdated').innerHTML =
            `<i class="fas fa-check-circle"></i> Updated: ${data.lastUpdated}`;
    }

    // Update shift stats
    function updateShiftStats(shifts) {
        const grid = document.getElementById('shiftGrid');
        const shiftClasses = {
            'F': 'first-shift',
            'G': 'general-shift',
            'S': 'second-shift'
        };

        let html = '';
        shifts.forEach(shift => {
            const total = shift.totalEmployees;
            const present = shift.presentEmployees;
            const absent = shift.absentEmployees;
            const layoff = shift.layoffEmployees || 0;

            const presentPercent = total > 0 ? Math.round((present / total) * 100) : 0;
            const absentPercent = total > 0 ? Math.round((absent / total) * 100) : 0;
            const layoffPercent = total > 0 ? Math.round((layoff / total) * 100) : 0;

            html += `
                <div class="shift-card ${shiftClasses[shift.shiftCode] || ''}">
                    <div class="shift-name">
                        <i class="fas fa-clock"></i> ${shift.shiftName}
                    </div>
                    <div class="shift-stats-row">
                        <div class="shift-metric">
                            <span class="shift-metric-value">${total.toLocaleString()}</span>
                            <span class="shift-metric-label">Total Staff</span>
                        </div>
                        <div class="shift-metric">
                            <span class="shift-metric-value">${shift.attendancePercentage.toFixed(1)}%</span>
                            <span class="shift-metric-label">Attendance Rate</span>
                        </div>
                    </div>
                    <div class="shift-progress-container">
                        <div class="shift-progress-bar">
                            <div class="progress-segments">
                                <div class="progress-segment present" style="width: ${presentPercent}%"></div>
                                <div class="progress-segment absent" style="width: ${absentPercent}%"></div>
                                <div class="progress-segment layoff" style="width: ${layoffPercent}%"></div>
                            </div>
                        </div>
                        <div class="progress-legend">
                            <div class="legend-item">
                                <div class="legend-color present"></div>
                                <span>Present (${presentPercent}%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color absent"></div>
                                <span>Absent (${absentPercent}%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color layoff"></div>
                                <span>Layoff (${layoffPercent}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        grid.innerHTML = html;
        document.getElementById('shiftLastUpdated').innerHTML =
            `<i class="fas fa-check-circle"></i> Updated: ${new Date().toLocaleTimeString()}`;
    }

    // Load real-time stats for regular users
    function loadRealTimeStats() {
        const companyCode = userRole === 'Admin' ? 0 : userCompanyCode;

        fetch('/Home/GetAttendanceStats?companyCode=' + companyCode)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateMainStats({
                        totalEmployees: data.totalEmployees,
                        presentEmployees: data.presentEmployees,
                        absentEmployees: data.absentEmployees,
                        layoffEmployees: data.layoffEmployees || 0,
                        lastUpdated: data.lastUpdated
                    });
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                document.getElementById('lastUpdated').innerHTML =
                    '<i class="fas fa-exclamation-triangle"></i> Update failed';
            });
    }

    // Load shift stats for regular users
    function loadShiftStats() {
        const companyCode = userRole === 'Admin' ? 0 : userCompanyCode;

        fetch('/Home/GetShiftAttendanceStats?companyCode=' + companyCode)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateShiftStats(data.shifts);
                }
            })
            .catch(error => {
                console.error('Error loading shift stats:', error);
                document.getElementById('shiftLastUpdated').innerHTML =
                    '<i class="fas fa-exclamation-triangle"></i> Update failed';
            });
    }

    // Refresh attendance data
    function refreshAttendance() {
        const refreshIcon = document.getElementById('refreshIcon');
        refreshIcon.classList.add('loading-spinner');

        fetch('/Home/RefreshAttendance', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                refreshIcon.classList.remove('loading-spinner');

                if (data.success) {
                    showNotification('Attendance data refreshed successfully!', 'success');

                    // Reload appropriate data based on user role
                    if (isSuperAdmin) {
                        loadAllCompaniesData();
                    } else {
                        loadRealTimeStats();
                        loadShiftStats();
                    }
                } else {
                    showNotification('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                refreshIcon.classList.remove('loading-spinner');
                showNotification('Failed to refresh data', 'error');
            });
    }

    // Show notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-' + (type === 'success' ? 'success' : 'danger') + ' position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; backdrop-filter: blur(10px);';
        notification.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-triangle') + '"></i> ' +
            message +
            '<button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>';

        document.body.appendChild(notification);

        setTimeout(function() {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== PAGE LOADED - DOMContentLoaded ===');
        console.log('isSuperAdmin:', isSuperAdmin);
        console.log('userRole:', userRole);

        if (isSuperAdmin) {
            console.log('Initializing Super Admin view...');

            // Load filter options and data for superadmin
            loadFilterOptions();
            loadAllCompaniesData();

            // Attach event listeners to filter dropdowns
            console.log('Attaching event listeners to filters...');

            const companyFilter = document.getElementById('companyFilter');
            const departmentFilter = document.getElementById('departmentFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            // const shiftFilter = document.getElementById('shiftFilter');

            if (companyFilter) {
                companyFilter.addEventListener('change', onFilterChange);
                console.log('✓ Company filter listener attached');
            } else {
                console.error('✗ companyFilter element not found!');
            }

            if (departmentFilter) {
                departmentFilter.addEventListener('change', onFilterChange);
                console.log('✓ Department filter listener attached');
            } else {
                console.error('✗ departmentFilter element not found!');
            }

            if (categoryFilter) {
                categoryFilter.addEventListener('change', onFilterChange);
                console.log('✓ Category filter listener attached');
            } else {
                console.error('✗ categoryFilter element not found!');
            }

            // if (shiftFilter) {
            //     shiftFilter.addEventListener('change', onFilterChange);
            //     console.log('✓ Shift filter listener attached');
            // } else {
            //     console.error('✗ shiftFilter element not found!');
            // }

            // Auto-refresh every 3 minutes for superadmin
            refreshInterval = setInterval(function() {
                console.log('Auto-refresh triggered (30 seconds)');
                loadAllCompaniesData();
            }, 30000);

            console.log('✓ Auto-refresh interval set (30 seconds)');
        } else {
            console.log('Initializing Regular User view...');

            // Load single company data for regular users
            loadRealTimeStats();
            loadShiftStats();

            // Auto-refresh every 3 minutes for regular users
            refreshInterval = setInterval(function() {
                loadRealTimeStats();
                loadShiftStats();
            }, 30000);
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
